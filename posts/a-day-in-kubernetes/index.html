<!doctype html><html lang=en-us><head><title>A day in Kubernetes | Stefano Boriero</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="You can consider this is a declaration of intent, but really is just a simple way to get the ball rolling on this project of mine. Like a more verbose Hello, World!"><meta name=generator content="Hugo 0.110.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-3XT5D2HP5W","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><nav class=navigation><a href=/><span class=arrow>‚Üê</span>Home</a>
<a href=/posts>Archive</a>
<a href=/tags>Tags</a>
<a href=/about>About</a></nav><main class=main><section id=single><h1 class=title>A day in Kubernetes</h1><div class=tip><time datetime="2022-12-11 00:00:00 +0000 UTC">Dec 11, 2022</time>
<span class=split>¬∑</span>
<span>1346 words</span>
<span class=split>¬∑</span>
<span>7 minute read</span></div><aside class=toc><details><summary>Table of Contents</summary><div><nav id=TableOfContents><ul><li><a href=#what-is-kubernetes>What is Kubernetes?</a><ul><li><a href=#pods>Pods</a></li><li><a href=#services>Services</a></li></ul></li><li><a href=#running-kubernetes-locally>Running Kubernetes locally</a><ul><li><a href=#my-application>My application</a></li><li><a href=#creating-my-first-deployment>Creating my first deployment</a></li><li><a href=#creating-my-first-service>Creating my first Service</a></li><li><a href=#accessing-the-application>Accessing the application</a></li></ul></li><li><a href=#bonus-part-scraping-my-pods-with-prometheus>Bonus part: scraping my Pods with Prometheus</a></li><li><a href=#running-out-of-disk-space>Running out of disk space</a></li><li><a href=#conclusion>Conclusion</a><ul><li><a href=#follow-up>Follow up</a></li></ul></li></ul></nav></div></details></aside><div class=content><p>Recentely I was asked if I had any experience in Kubernetes: well, long story short, I don&rsquo;t :)</p><p>But it poked my interest a bit, so I decided to give it a try and see what I can learn about it in a short time. It&rsquo;s a rainy Sunday, so it seems like a perfect day to concentrate and take a deep dive on the topic. Ideally I&rsquo;d want to be able to deploy a couple of services in Kubernetes and have them communicate with each other.</p><h2 id=what-is-kubernetes>What is Kubernetes? <a href=#what-is-kubernetes class=anchor>üîó</a></h2><p>According to their <a href=https://kubernetes.io/docs/concepts/overview/ target=_blank rel=noopener>official documentation</a></p><blockquote><p>Kubernetes is a portable, extensible, open source platform for managing containerized workloads and services, that facilitates both declarative configuration and automation.</p></blockquote><p>That&rsquo;s a nice definition, but I believe I need to dig deeper to really understanding. Having a look at the documentation Kubernetes seems humongous! Let&rsquo;s try to focus on the bare minimum we&rsquo;ll need to deploy an application: let&rsquo;s start by having a look at what a Pod is</p><h3 id=pods>Pods <a href=#pods class=anchor>üîó</a></h3><p>Quoting from <a href=https://kubernetes.io/docs/concepts/overview/ target=_blank rel=noopener>https://kubernetes.io/docs/concepts/overview/</a></p><blockquote><p>Pods are the smallest deployable units of computing that you can create and manage in Kubernetes. A Pod (as in a pod of whales or pea pod) is a group of one or more containers, with shared storage and network resources, and a specification for how to run the containers.</p></blockquote><p>For me, coming from the ECS world, this really resembles what a Task is. Okay, so what we&rsquo;ll probably do is we&rsquo;re going to deploy instances of our application as Pods. But there must be a way to group multiple Pods/instances of our app under a common umbrella.</p><h3 id=services>Services <a href=#services class=anchor>üîó</a></h3><p>Quoting from <a href=https://kubernetes.io/docs/concepts/services-networking/service/ target=_blank rel=noopener>https://kubernetes.io/docs/concepts/services-networking/service/</a></p><blockquote><p>An abstract way to expose an application running on a set of Pods as a network service. With Kubernetes you don&rsquo;t need to modify your application to use an unfamiliar service discovery mechanism. Kubernetes gives Pods their own IP addresses and a single DNS name for a set of Pods, and can load-balance across them.</p></blockquote><p>Nice, this is what I was expecting to find! It even comes with Load Balancing out of the box, sweet.</p><p>So we&rsquo;ll want to deploy an application as one or more Pods, and expose it via a Service. I think we have enough to start and finish in one day. So let&rsquo;s get to work</p><h2 id=running-kubernetes-locally>Running Kubernetes locally <a href=#running-kubernetes-locally class=anchor>üîó</a></h2><p>Well, one sure thing about Kubernetes is that it&rsquo;s BIG. It was not designed to run locally on a consumer machine, but luckily there are well supported flavours of Kubernetes that can be run locally, like <a href=https://minikube.sigs.k8s.io/docs/ target=_blank rel=noopener>minikube</a> for instance. So let&rsquo;s follow the installation <a href=https://minikube.sigs.k8s.io/docs/start/ target=_blank rel=noopener>instructions</a> and try to run it with <code>minikube start</code> command. And I got the first error, not off to a sparkling start :sweat-smile:</p><blockquote><p>Exiting due to <code>RSRC_DOCKER_STORAGE</code>: Docker is out of disk space! (/var is at 99% of capacity). You can pass &lsquo;&ndash;force&rsquo; to skip this check.</p></blockquote><p>If I were running on Windows or MacOS, I could give the linux VM that is spinned up by Docker more memory from the Docker Desktop configuration: unfortunately I&rsquo;m running on Linux, so this error just means I have some cleanup to do. After removing stale docker resources witht the <code>docker system prune</code> command, I was finally able to start minikube üéâ!</p><p>With the command <code>minikube dashboard</code> I&rsquo;m able to see a nice dashboard displaying the cluster current state: this is going to be very useful to exepriment a bit.</p><p><p class=markdown-image><img src=/images/a-day-in-kubernetes/minikube-dashboard.png alt="Minikube dashboard"></p></p><h3 id=my-application>My application <a href=#my-application class=anchor>üîó</a></h3><p>SpringBoot is a framework I grew familiar with, so I chose it to create <a href=https://github.com/StefanoBoriero/kubernetes-demo target=_blank rel=noopener>this sample Hello, world! application</a> that exposes a few simple endpoints returning static text. Have a look if you fancy, but I want to focus more on deploying this to Kubernetes rather than the app itself.</p><h3 id=creating-my-first-deployment>Creating my first deployment <a href=#creating-my-first-deployment class=anchor>üîó</a></h3><p>Now I have a running local Kubernetes cluster, and a Docker image: time to deploy!
Kubernetes takes a declarative approach to deployments. This means that you can focus on declaring the desired state rather than imperatively enumerate all the instructions yourself.</p><p>I created the following deployement descriptor:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>kubernetes-demo-deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>kubernetes-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>kubernetes-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>kubernetes-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>kubernetes-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>stefanoboriero/kubernetes-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>kubernetes-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>8080</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>This means that I want 2 Pods (<code>replicas: 2</code>) and each Pod is just one container running the <code>stefanoboriero/kubernetes-demo</code> image, with a named port opened at 8080. Pretty simple. Let&rsquo;s apply this with the command <code>minikube kubectl -- apply -f kubernetes/deployment.yml</code> and see what happens.</p><blockquote><p>deployment.apps/kubernetes-demo-deployment created</p></blockquote><p>Sweet! If I have a look at the minikube dashboard, I can see both the deployment and the 2 Pods running. Great, but now how can I make requests to the application?</p><p><p class=markdown-image><img src=/images/a-day-in-kubernetes/deployment.png alt=Deployment></p></p><h3 id=creating-my-first-service>Creating my first Service <a href=#creating-my-first-service class=anchor>üîó</a></h3><p>Services are what I&rsquo;m looking for. There are <a href=https://kubernetes.io/docs/concepts/services-networking/service/#publishing-services-service-types target=_blank rel=noopener>different service types</a> but the most appropriate for my local experiment is NodePort type.</p><p>I created the following Service definition:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>kubernetes-demo-service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>NodePort<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>kubernetes-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>protocol</span>:<span style=color:#bbb> </span>TCP<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>8080</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>targetPort</span>:<span style=color:#bbb> </span><span style=color:#666>8080</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>nodePort</span>:<span style=color:#bbb> </span><span style=color:#666>30003</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>http<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>clusterIP</span>:<span style=color:#bbb> </span><span style=color:#666>10.100.184.41</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>The <code>selector</code> object defines what Pods are part of this service: it&rsquo;s handy that I don&rsquo;t have to specify their Ips or anything, so even if I add or remove Pods when the app scales up or down, the selector will just pick them up. I specified both <code>port</code> and <code>targetPort</code> because, remember, this acts also as a LoadBalancer: so the <code>port</code> field is the port where the LoadBalancer is listening, and <code>targetPort</code> is the port of the Pod behind it. In this case they&rsquo;re both 8080 and I could have omitted the <code>targetPort</code> because the same value is used by default, but I wanted to be as explicit as possible. <code>nodePort</code> is the port on the Kubernetes node that is accessible from outside the cluster, I hardcoded it for predictability and replicability of the example. Finally, <code>clusterIP</code> is the IP that is reacheable only from inside the Kubernetes cluster.</p><p>Let&rsquo;s run <code>minikube kubectl -- apply -f kubernetes/service.yml</code> and apply this</p><blockquote><p>service/kubernetes-demo-service created</p></blockquote><p>And I can see the service in the minikube dashboard as well!</p><p><p class=markdown-image><img src=/images/a-day-in-kubernetes/service.png alt=Services></p></p><h3 id=accessing-the-application>Accessing the application <a href=#accessing-the-application class=anchor>üîó</a></h3><p>My application is now accessible at http://192.168.49.2:30003/hello!</p><p>There are a few other endpoints just to test out few different ways to connect between services in the cluster:</p><ul><li>http://192.168.49.2:30003/forwardUsingExternalisedService will get the response contacting a second service using its externalised ip.</li><li>http://192.168.49.2:30003/forwardUsingClusterIp will get the response contacting a second service using its internal clusterIP.</li><li>http://192.168.49.2:30003/forwardUsingServiceName will get the response contacting a second service using its service name, letting Kubernetes resolve the actual service ip.</li></ul><p>If I&rsquo;m running another instance of my application oustide Kubernetes, then only the first will work.</p><p>That&rsquo;s great! I achieved what I was looking forward to.</p><h2 id=bonus-part-scraping-my-pods-with-prometheus>Bonus part: scraping my Pods with Prometheus <a href=#bonus-part-scraping-my-pods-with-prometheus class=anchor>üîó</a></h2><p>Knowing how important Observability is even in early stages of development, I additionally tried to deploy a Prometheus instance that would scrape my Pods following <a href=https://devopscube.com/setup-prometheus-monitoring-on-kubernetes/ target=_blank rel=noopener>these instructions</a>. That gave me the possibility of seeing few other bits of Kubernetes in action, like ClusterRoles, ServiceAccounts and ConfigMap. And there you can see my Pods being scraped!</p><p><p class=markdown-image><img src=/images/a-day-in-kubernetes/prometheus.png alt=Prometheus></p></p><h2 id=running-out-of-disk-space>Running out of disk space <a href=#running-out-of-disk-space class=anchor>üîó</a></h2><p>After that, my laptop ran out of disk space :sweat-smile: so I started getting all sorts of errors like</p><blockquote><p>E1212 02:57:43.099164 426734 root.go:80] failed to log command start to audit: unable to write to audit log: write /home/stefano/.minikube/logs/audit.json: no space left on device</p></blockquote><p>So it was time to turn off the laptop :)</p><h2 id=conclusion>Conclusion <a href=#conclusion class=anchor>üîó</a></h2><p>I liked it! I think Kubernetes does a good job at easing the deployment of containerised services with its declarative approach. I also like the way the networking is taken care of, being able to resolve service names via the internal DNS makes it possible to randomise IP address at will. And it has so many more features that I didn&rsquo;t had the chanche to explore!</p><h3 id=follow-up>Follow up <a href=#follow-up class=anchor>üîó</a></h3><p>When I&rsquo;ll have some more time I&rsquo;d like to take a look at how services can be horizontally scaled, and how the LoadBalancing can be configured. Ingress is another crucial component I didn&rsquo;t have the time to play with.</p></div><div class=tags><a href=https://stefanoboriero.github.io/tags/kubernetes>kubernetes</a>
<a href=https://stefanoboriero.github.io/tags/hackday>hackday</a></div><div id=comment><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//your-disqus-shortname.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></section></main><footer id=footer><div id=social><a class=symbol href=https://github.com/StefanoBoriero rel=me target=_blank><svg fill="#bbb" width="28" height="28" viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>Github</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)"><g id="Github" transform="translate(264.000000, 939.000000)"><path d="M8 72H64c4.418278.0 8-3.581722 8-8V8c0-4.418278-3.581722-8-8-8H8c-4.418278 811624501e-24-8 3.581722-8 8V64c541083001e-24 4.418278 3.581722 8 8 8z" id="Rounded" fill="#bbb"/><path d="M35.9985 13C22.746 13 12 23.7870921 12 37.096644c0 10.6440272 6.876 19.6751861 16.4145 22.8617681C29.6145 60.1797862 30.0525 59.4358488 30.0525 58.7973276 30.0525 58.2250681 30.0315 56.7100863 30.0195 54.6996482c-6.6765 1.4562499-8.085-3.2302544-8.085-3.2302544-1.0905-2.7829884-2.664-3.5239139-2.664-3.5239139C17.091 46.4500754 19.4355 46.4801943 19.4355 46.4801943c2.4075.1701719 3.675 2.4833051 3.675 2.4833051 2.142 3.6820383 5.6175 2.6188404 6.9855 2.0014024C30.3135 49.4077535 30.9345 48.3460615 31.62 47.7436831 26.2905 47.1352808 20.688 45.0691228 20.688 35.8361671c0-2.6308879.9345-4.781379 2.4705-6.4665327C22.911 28.7597262 22.0875 26.3110578 23.3925 22.9934585c0 0 2.016-.6475568 6.6 2.4697516C31.908 24.9285993 33.96 24.6620468 36.0015 24.6515052 38.04 24.6620468 40.0935 24.9285993 42.0105 25.4632101c4.581-3.1173084 6.5925-2.4697516 6.5925-2.4697516C49.9125 26.3110578 49.089 28.7597262 48.8415 29.3696344 50.3805 31.0547881 51.309 33.2052792 51.309 35.8361671c0 9.2555448-5.6115 11.29309-10.9575 11.8894446.860999999999997.7439374 1.629 2.2137408 1.629 4.4621184C41.9805 55.4089489 41.9505 58.0067059 41.9505 58.7973276 41.9505 59.4418726 42.3825 60.1918338 43.6005 59.9554002 53.13 56.7627944 60 47.7376593 60 37.096644 60 23.7870921 49.254 13 35.9985 13" fill="#fff"/></g></g></g></svg></a></div><div class=copyright>¬© Copyright
2023
<span class=split><svg fill="#bbb" width="15" height="15" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M13.91 6.75c-1.17 2.25-4.3 5.31-6.07 6.94-.1903.1718-.4797.1718-.67.0C5.39 12.06 2.26 9 1.09 6.75-1.48 1.8 5-1.5 7.5 3.45 10-1.5 16.48 1.8 13.91 6.75z"/></svg></span>Stefano Boriero</div><div class=powerby>Powered by <a href=http://www.gohugo.io/>Hugo</a> Theme By <a href=https://github.com/nodejh/hugo-theme-mini>nodejh</a></div></footer></body></html>